<!DOCTYPE html>
<html lang="cn">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"zsdlove.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.22.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="安全扫描技术分享">
<meta property="og:type" content="website">
<meta property="og:title" content="pOny&#39;s blog">
<meta property="og:url" content="https://zsdlove.github.io/index.html">
<meta property="og:site_name" content="pOny&#39;s blog">
<meta property="og:description" content="安全扫描技术分享">
<meta property="og:locale">
<meta property="article:author" content="pOny">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://zsdlove.github.io/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"cn","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>pOny's blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">pOny's blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>







</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">pOny</p>
  <div class="site-description" itemprop="description">安全扫描技术分享</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">4</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zsdlove.github.io/2025/03/10/Artemis-SAST/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="pOny">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pOny's blog">
      <meta itemprop="description" content="安全扫描技术分享">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | pOny's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
              <span class="post-sticky-flag" title="Sticky">
                <i class="fa fa-thumbtack"></i>
              </span><a href="/2025/03/10/Artemis-SAST/" class="post-title-link" itemprop="url">Artemis-SAST</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-03-10 22:47:48" itemprop="dateCreated datePublished" datetime="2025-03-10T22:47:48+08:00">2025-03-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-04-21 13:11:31" itemprop="dateModified" datetime="2025-04-21T13:11:31+08:00">2025-04-21</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Artemis-Download"><a href="#Artemis-Download" class="headerlink" title="Artemis Download"></a>Artemis Download</h1><p><a target="_blank" rel="noopener" href="https://github.com/zsdlove/Artemis-release/releases/">download</a></p>
<h1 id="Artemis-Introduction"><a href="#Artemis-Introduction" class="headerlink" title="Artemis Introduction"></a>Artemis Introduction</h1><p><a href="https://zsdlove.github.io/2025/03/03/Artemis-%E9%9D%99%E6%80%81%E4%BB%A3%E7%A0%81%E6%89%AB%E6%8F%8F%E5%99%A8%E4%BB%8B%E7%BB%8D/">introduction</a></p>
<h1 id="Artemis-Documentation"><a href="#Artemis-Documentation" class="headerlink" title="Artemis Documentation"></a>Artemis Documentation</h1><p><a href="https://zsdlove.github.io/2025/03/10/Artemis-Documentation/">documentation</a></p>
<h1 id="Knowledge-Planet"><a href="#Knowledge-Planet" class="headerlink" title="Knowledge Planet"></a>Knowledge Planet</h1><p><img src="/images/xq.png" alt="星球"></p>
<h1 id="Wechat"><a href="#Wechat" class="headerlink" title="Wechat"></a>Wechat</h1><p><img src="/images/wechat.jpeg" alt="wechat"></p>
<h1 id="Other"><a href="#Other" class="headerlink" title="Other"></a>Other</h1><p><img src="/images/thanks.png" alt="other"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zsdlove.github.io/2025/03/10/Artemis-Documentation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="pOny">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pOny's blog">
      <meta itemprop="description" content="安全扫描技术分享">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | pOny's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/03/10/Artemis-Documentation/" class="post-title-link" itemprop="url">Artemis Documentation</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-03-10 20:50:06" itemprop="dateCreated datePublished" datetime="2025-03-10T20:50:06+08:00">2025-03-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-03-18 02:46:27" itemprop="dateModified" datetime="2025-03-18T02:46:27+08:00">2025-03-18</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Installation"><a href="#Installation" class="headerlink" title="Installation"></a>Installation</h1><h2 id="获取软件最新版本"><a href="#获取软件最新版本" class="headerlink" title="获取软件最新版本"></a>获取软件最新版本</h2><p>用户可从<a target="_blank" rel="noopener" href="https://github.com/zsdlove/Artemis-release/releases/">https://github.com/zsdlove/Artemis-release/releases/</a> 下载最新的Artemis扫描器。</p>
<h2 id="配置清单"><a href="#配置清单" class="headerlink" title="配置清单"></a>配置清单</h2><p>Artemis 代码安全扫描器包含主体引擎Artemis.jar和两个配置文件Checker.xml和build.properties。其中，Checker.xml中包含扫描器内置规则以及用户自定义规则；build.properties包含编译配置，以及其他的一些扫描器必要的运行时配置。</p>
<h2 id="环境依赖"><a href="#环境依赖" class="headerlink" title="环境依赖"></a>环境依赖</h2><ul>
<li>Artemis依赖jdk11之后的所有版本，请确保运行环境中的jdk大于jdk11。</li>
<li>编译捕获所需的jdk可通过命令行参数或配置文件另外配置，如果没有配置，则默认继承Artemis运行环境所以依赖的jdk版本。</li>
</ul>
<h1 id="Quickstart"><a href="#Quickstart" class="headerlink" title="Quickstart"></a>Quickstart</h1><h2 id="基本原理说明"><a href="#基本原理说明" class="headerlink" title="基本原理说明"></a>基本原理说明</h2><p>Artemis代码分析主要分两步，第一步是进行代码编译捕获，第二步是进行代码扫描分析。其中第一步需要将代码转换为中间语义文件*.art，第二步则使用指定规则对捕获的语义文件进行分析。</p>
<h2 id="基本使用说明"><a href="#基本使用说明" class="headerlink" title="基本使用说明"></a>基本使用说明</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pony@ponydeMBP 1.0.0 % java -jar Artemis.jar -h</span><br><span class="line">Usage: SAST [-hV] [-bc=&lt;build_cmd&gt;] [-d=&lt;dbpath&gt;] [-j=&lt;java_home&gt;]</span><br><span class="line">            [-mr=&lt;mr_enable&gt;] [-od=&lt;out_dbpath&gt;] [-p=&lt;path&gt;] [-r=&lt;rulePath&gt;]</span><br><span class="line">            [-t=&lt;mr_target_path&gt;]</span><br><span class="line">static code analysis.</span><br><span class="line">      -bc, --build-command=&lt;build_cmd&gt;</span><br><span class="line">                            指定编译命令.</span><br><span class="line">  -d, --database=&lt;dbpath&gt;   指定加载的数据库路径.</span><br><span class="line">  -h, --help                Show this help message and exit.</span><br><span class="line">  -j, --java-home=&lt;java_home&gt;</span><br><span class="line">                            指定java_home路径.</span><br><span class="line">      -mr, --mr-enable=&lt;mr_enable&gt;</span><br><span class="line">                            是否启用mr扫描.</span><br><span class="line">      -od, --output-database=&lt;out_dbpath&gt;</span><br><span class="line">                            指定输出的编译数据库路径.</span><br><span class="line">  -p, --path=&lt;path&gt;         指定源码路径.</span><br><span class="line">  -r, --rule=&lt;rulePath&gt;     指定规则路径.</span><br><span class="line">  -t, --mr-target-path=&lt;mr_target_path&gt;</span><br><span class="line">                            指定target数据库路径.</span><br><span class="line">  -V, --version             Print version information and exit.</span><br></pre></td></tr></table></figure>
<h2 id="靶场示例"><a href="#靶场示例" class="headerlink" title="靶场示例"></a>靶场示例</h2><p><a target="_blank" rel="noopener" href="https://github.com/JoyChou93/java-sec-code.git">https://github.com/JoyChou93/java-sec-code.git</a><br>这个靶场做得还是比较用心的，一直以来测试都是用的这个靶场。</p>
<h2 id="使用步骤"><a href="#使用步骤" class="headerlink" title="使用步骤"></a>使用步骤</h2><p>java-sec-code编译依赖jdk1.8，所以我们需要在build.properties配置文件中指定java8环境配置指定如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">java_home = /Library/Java/JavaVirtualMachines/jdk1.8.0_151.jdk/Contents/Home</span><br><span class="line">report_output=report.json</span><br><span class="line">build_cmd= mvn clean package -X -DskipTests=true</span><br><span class="line">out_dir=workspace</span><br><span class="line">model_name=deepseek-ai/DeepSeek-V2.5</span><br><span class="line">max_token=512</span><br><span class="line">temperature=0.7</span><br><span class="line">top_p=0.7</span><br><span class="line">top_k=50</span><br><span class="line">frequency_penalty=0.5</span><br><span class="line">n=1</span><br><span class="line">model_api=https://api.siliconflow.cn/v1/chat/completions</span><br><span class="line">licenseData=Licensed to: pOny, Expires: 2025-4-31</span><br><span class="line">publicKey=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAxidJDQRCW3aITgFN5vVF4tuaMu85igETA+cR4Pg//+aJfpjockyvAmdEiz0fKOlm+HyXDDGSzuzVgtf4MFEEI+I/UeON2BstGqE0kQd4KLs7+MbzmDttVzixVICl4i57LBHbh3Ef7ZwALknvhURH5XaZpqlIobSiiphf12uoFALK7sMfQDq0KFlkZnmvydDoF8leqqoh5wVwaA/0kKjrWH0pUu+x/l7EVxyqCsEXKdd2WYOE6zxfDxQkbBGYCjZ8W6AUQygy0T9/qXZRy4g16dN99TbnrcKTts8p1fMTOZgj9lEHtKaaDs8HvQa0CkHF1iCV6WI/5gWF9K9S4ZafwQIDAQAB</span><br><span class="line">signature=T1kqV8LWUhLd2rTtyROpgYx30tGFQDnoQCicQUXvvwWqf9uyD/dvx6ivVZua2LZHbxUU85WtryRA25AGeMvXaG9KVpWYeUwnUbG4lx/w3D0eWFcoloTmRdeYgYl9q9OxhR+n7CH5CoveghZU05ZGqIlLxeglrbnlCNB8n8J1NHVxMyvpTBl9vYxfx39WyvSTIytwXZb4vnwWXQVbUwdVmuHQuKHfpPBf0W1VnvQ/p3WDgRyAbL0v2e2eITMd7SGSU/9VC23kZjCy8p/cSNZ/VivEth6BFW1k52Gis4alNR9OZUbMsgrYcpo6ORCL+gOAU1RQiO+spffPhBipa9u4gg==</span><br></pre></td></tr></table></figure>
<p>编译命令指定为mvn clean package -X -DskipTests&#x3D;true，其他默认即可。下面指定以下命令开启编译</p>
<h3 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h3><p>执行以下命令进行编译捕获</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar Artemis.jar -p test/java-sec-code-master</span><br></pre></td></tr></table></figure>
<details>
  <summary>编译执行实战</summary>
  <video src="/images/编译.mov" controls="controls"></video>
</details>
如果你实现编译过，本地已经有依赖包缓存了，那这个捕获过程大概耗时10秒，如果没有编译过，那这个过程可能会耗时稍稍多一些。

<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>下面我们开始进行漏洞分析，我们直接执行以下命令即可：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar Artemis.jar -d workspace</span><br></pre></td></tr></table></figure>
<p>其中，workspace是我们指定的数据库保存的目录。</p>
<details>
  <summary>分析执行实战</summary>
  <video src="/images/分析.mov" controls="controls"></video>
</details>
可以看到这个过程大概耗时6秒，对于一些诸如java-sec-code-master这样小型的项目，Artemis的分析速度极快，如果再配合上mr扫描，那速度将会相当令人欣喜。

<h1 id="merge-request-scan"><a href="#merge-request-scan" class="headerlink" title="merge request scan"></a>merge request scan</h1><p>执行以下命令进行merge request scan，其中-t指定前一个版本的数据库，-mr指定是否启用mr扫描，-od指定新的数据库的地址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar Artemis.jar -p test/java-sec-code-master -t workspace -mr true -od workspace2</span><br></pre></td></tr></table></figure>
<details>
  <summary>mr扫描实战</summary>
  <video src="/images/mrscan.mov" controls="controls"></video>
</details>

<h1 id="Database"><a href="#Database" class="headerlink" title="Database"></a>Database</h1><h2 id="节点描述"><a href="#节点描述" class="headerlink" title="节点描述"></a>节点描述</h2><table>
<thead>
<tr>
<th>节点</th>
<th>说明</th>
<th>如何获取</th>
</tr>
</thead>
<tbody><tr>
<td>YieldStmt</td>
<td>yield语句</td>
<td>示例：db.nodes.where(_.getClass.getSimpleName&#x3D;&#x3D;”YieldStmt”)</td>
</tr>
<tr>
<td>MethodCallReferenceExpr</td>
<td>方法引用语句</td>
<td>类似第一个示例</td>
</tr>
<tr>
<td>ArrayAccessExpr</td>
<td>数组访问表达式</td>
<td>类似第一个示例</td>
</tr>
<tr>
<td>ConditionExpr</td>
<td>条件表达式</td>
<td>类似第一个示例</td>
</tr>
<tr>
<td>AssignExpr</td>
<td>赋值表达式</td>
<td>类似第一个示例</td>
</tr>
<tr>
<td>BreakStmt</td>
<td>break语句</td>
<td>类似第一个示例</td>
</tr>
<tr>
<td>BooleanLiteralExpr</td>
<td>布尔表达式</td>
<td>类似第一个示例</td>
</tr>
<tr>
<td>DoStmt</td>
<td>do语句</td>
<td>类似第一个示例</td>
</tr>
<tr>
<td>SwitchExpr</td>
<td>switch语句</td>
<td>类似第一个示例</td>
</tr>
<tr>
<td>LambdaExpr</td>
<td>lambda表达式</td>
<td>类似第一个示例</td>
</tr>
<tr>
<td>AnnotationStmt</td>
<td>注解语句</td>
<td>类似第一个示例</td>
</tr>
<tr>
<td>NullLiteralExpr</td>
<td>空值表达式</td>
<td>类似第一个示例</td>
</tr>
<tr>
<td>ReturnStmt</td>
<td>返回语句</td>
<td>类似第一个示例</td>
</tr>
<tr>
<td>ThrowStmt</td>
<td>throw语句</td>
<td>类似第一个示例</td>
</tr>
<tr>
<td>NameExpr</td>
<td>名字表达式</td>
<td>类似第一个示例</td>
</tr>
<tr>
<td>BlockStmt</td>
<td>基本块</td>
<td>类似第一个示例</td>
</tr>
<tr>
<td>LongLiteralExpr</td>
<td>长整型表达式</td>
<td>类似第一个示例</td>
</tr>
<tr>
<td>CastExpr</td>
<td>强制转换表达式</td>
<td>类似第一个示例</td>
</tr>
<tr>
<td>TypeDecl</td>
<td>类型声明</td>
<td>类似第一个示例</td>
</tr>
<tr>
<td>FieldAccessExpr</td>
<td>字段访问表达式</td>
<td>类似第一个示例</td>
</tr>
<tr>
<td>MethodDecl</td>
<td>函数声明</td>
<td>类似第一个示例</td>
</tr>
<tr>
<td>ForStmt</td>
<td>for语句</td>
<td>类似第一个示例</td>
</tr>
<tr>
<td>ForeachStmt</td>
<td>foreach语句</td>
<td>类似第一个示例</td>
</tr>
<tr>
<td>WhileStmt</td>
<td>while语句</td>
<td>类似第一个示例</td>
</tr>
<tr>
<td>IntegerLiteralExpr</td>
<td>整型值表达式</td>
<td>类似第一个示例</td>
</tr>
<tr>
<td>VariableDeclarator</td>
<td>变量声明者</td>
<td>类似第一个示例</td>
</tr>
<tr>
<td>CatchClause</td>
<td>catchclause声明</td>
<td>类似第一个示例</td>
</tr>
<tr>
<td>IfStmt</td>
<td>if语句</td>
<td>类似第一个示例</td>
</tr>
<tr>
<td>ObjectCreationExpr</td>
<td>对象创建</td>
<td>类似第一个示例</td>
</tr>
<tr>
<td>ParameterStmt</td>
<td>参数语句</td>
<td>类似第一个示例</td>
</tr>
<tr>
<td>ExprStmt</td>
<td>表达式语句</td>
<td>类似第一个示例</td>
</tr>
<tr>
<td>SwitchStmt</td>
<td>switch语句</td>
<td>类似第一个示例</td>
</tr>
<tr>
<td>BinaryExpr</td>
<td>binary表达式</td>
<td>类似第一个示例</td>
</tr>
<tr>
<td>ArrayInitializerExpr</td>
<td>数组初始化表达式</td>
<td>类似第一个示例</td>
</tr>
<tr>
<td>DoubleLiteralExpr</td>
<td>Double值表达式</td>
<td>类似第一个示例</td>
</tr>
<tr>
<td>CallExpr</td>
<td>函数调用表达式</td>
<td>类似第一个示例</td>
</tr>
<tr>
<td>TryStmt</td>
<td>try语句</td>
<td>类似第一个示例</td>
</tr>
<tr>
<td>FinallyStmt</td>
<td>finally语句</td>
<td>类似第一个示例</td>
</tr>
<tr>
<td>VariableDecExpr</td>
<td>变量声明表达式</td>
<td>类似第一个示例</td>
</tr>
<tr>
<td>TypeExpr</td>
<td>类型表达式</td>
<td>类似第一个示例</td>
</tr>
<tr>
<td>ArrayCreateExpr</td>
<td>数组创建表达式</td>
<td>类似第一个示例</td>
</tr>
<tr>
<td>SwitchEntry</td>
<td>switch入口</td>
<td>类似第一个示例</td>
</tr>
<tr>
<td>StringLiteralExpr</td>
<td>字符串值表达式</td>
<td>类似第一个示例</td>
</tr>
<tr>
<td>XMLNode</td>
<td>xml节点</td>
<td>类似第一个示例</td>
</tr>
</tbody></table>
<h2 id="节点基本属性描述"><a href="#节点基本属性描述" class="headerlink" title="节点基本属性描述"></a>节点基本属性描述</h2><p>每一个节点的最终父类都是AST，其中，AST的基本数据结构如下</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>类型</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>id</td>
<td>int</td>
<td>节点编号，具有唯一性</td>
</tr>
<tr>
<td>code</td>
<td>sting</td>
<td>节点代码</td>
</tr>
<tr>
<td>start_line</td>
<td>int</td>
<td>节点起始行</td>
</tr>
<tr>
<td>end_line</td>
<td>int</td>
<td>节点结束行</td>
</tr>
<tr>
<td>parent</td>
<td>int</td>
<td>父节点</td>
</tr>
<tr>
<td>filePath</td>
<td>string</td>
<td>文件路径</td>
</tr>
<tr>
<td>method_id</td>
<td>int</td>
<td>节点所在函数</td>
</tr>
</tbody></table>
<h1 id="Basic-Usages"><a href="#Basic-Usages" class="headerlink" title="Basic Usages"></a>Basic Usages</h1><h2 id="关键词使用说明"><a href="#关键词使用说明" class="headerlink" title="关键词使用说明"></a>关键词使用说明</h2><table>
<thead>
<tr>
<th>关键字</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>db</td>
<td>数据库，所有的数据都从这来</td>
<td></td>
</tr>
<tr>
<td>call</td>
<td>函数调用</td>
<td>db.call</td>
</tr>
<tr>
<td>method</td>
<td>函数声明</td>
<td>db.method</td>
</tr>
<tr>
<td>types</td>
<td>类型声明</td>
<td>db.types</td>
</tr>
<tr>
<td>xml</td>
<td>xml文件信息</td>
<td>db.xml</td>
</tr>
<tr>
<td>where</td>
<td>条件判断</td>
<td>db.call.where(_.name&#x3D;&#x3D;”niceshot”)</td>
</tr>
<tr>
<td>whereNot</td>
<td>条件判断</td>
<td>db.call.whereNot(_.name&#x3D;&#x3D;”nicejob”)</td>
</tr>
<tr>
<td>filter</td>
<td>条件过滤</td>
<td>db.call.filter(_.name&#x3D;&#x3D;”nicejob”)</td>
</tr>
<tr>
<td>limit</td>
<td>枚举限制，限制获取的节点数量</td>
<td>db.call.limit(10)</td>
</tr>
<tr>
<td>methodDeclaration</td>
<td>获取函数调用对应的函数声明信息</td>
<td>callExpr.methodDeclaration</td>
</tr>
<tr>
<td>hasPathTo</td>
<td>污点路径追踪</td>
<td>sink.hasPathTo(source)</td>
</tr>
</tbody></table>
<h1 id="Rule-Develop"><a href="#Rule-Develop" class="headerlink" title="Rule Develop"></a>Rule Develop</h1><p>以下是一个sql注入检测规则的示例，阁下可仿造此规则编写其他漏洞检测规则，编写的规则放置在Checker.xml的customize-rules节点下即可。规则编号你可以自定义，不过，如果自定义编号的话，你需要补充这个编号对应的描述信息。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">val sources:List[ParameterStmt]= db.method</span><br><span class="line">    .where(_.annotation.nonEmpty)</span><br><span class="line">    .where &#123;</span><br><span class="line">      it =&gt; &#123;</span><br><span class="line">        it.annotation.count(_.code.contains(&quot;RequestMapping&quot;))&gt;0</span><br><span class="line">          || it.annotation.count(_.code.contains(&quot;GetMapping&quot;))&gt;0</span><br><span class="line">          || it.annotation.count(_.code.contains(&quot;ResponseBody&quot;))&gt;0</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    .filter(_.params.nonEmpty).map(_.params.head)</span><br><span class="line">val sink:List[Expr]=db.call.where&#123;</span><br><span class="line">      it=&gt;&#123;</span><br><span class="line">        it.fullName==&quot;java.sql.Statement.executeQuery&quot;</span><br><span class="line">        || it.fullName==&quot;java.sql.Statement.addBatch&quot;</span><br><span class="line">        || it.fullName==&quot;java.sql.Statement.execute&quot;</span><br><span class="line">        || it.fullName==&quot;java.sql.Statement.executeLargeUpdate&quot;</span><br><span class="line">        || it.fullName==&quot;java.sql.Statement.executeUpdate&quot;</span><br><span class="line">        || it.fullName==&quot;java.sql.Statement.executeBatch&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;.filter(_.arguments.nonEmpty).map(_.arguments.head)</span><br><span class="line">val paths=sink.hashPathTo(sources)</span><br><span class="line">paths.show //打印路径</span><br><span class="line">paths.num //统计路径数量</span><br></pre></td></tr></table></figure>
<p>注意事项：</p>
<ul>
<li>注意规则每一行规则代码都需要加上<code>&lt;br&gt;</code>进行换行，否则后端规则编译器会编译异常。</li>
<li>规则需要使用cdata节点进行包裹，以避免规则中的关键词对xml的解析产生影响。</li>
</ul>
<h1 id="online-query"><a href="#online-query" class="headerlink" title="online query"></a>online query</h1><h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><p>从1.1.0版本起，artemis支持在线query。可通过以下命令启动一个query服务器：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar Artemis.jar -d [path/to/database] -sp 8089</span><br></pre></td></tr></table></figure>
<p>（注：sp指定端口号）</p>
<h2 id="接口请求示例"><a href="#接口请求示例" class="headerlink" title="接口请求示例"></a>接口请求示例</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:8089/query?data=db.method.last.fullname</span><br></pre></td></tr></table></figure>
<p>其中，data参数后面跟我们query的语句</p>
<h2 id="演示"><a href="#演示" class="headerlink" title="演示"></a>演示</h2><h3 id="启动服务器"><a href="#启动服务器" class="headerlink" title="启动服务器"></a>启动服务器</h3><details>
  <summary>启动服务器演示</summary>
  <video src="/images/启动服务.mov" controls="controls"></video>
</details>

<h3 id="在线query"><a href="#在线query" class="headerlink" title="在线query"></a>在线query</h3><details>
  <summary>在线query演示</summary>
  <video src="/images/在线query.mov" controls="controls"></video>
</details>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zsdlove.github.io/2025/03/03/Artemis-%E9%9D%99%E6%80%81%E4%BB%A3%E7%A0%81%E6%89%AB%E6%8F%8F%E5%99%A8%E4%BB%8B%E7%BB%8D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="pOny">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pOny's blog">
      <meta itemprop="description" content="安全扫描技术分享">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | pOny's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/03/03/Artemis-%E9%9D%99%E6%80%81%E4%BB%A3%E7%A0%81%E6%89%AB%E6%8F%8F%E5%99%A8%E4%BB%8B%E7%BB%8D/" class="post-title-link" itemprop="url">Artemis 静态代码扫描器介绍</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-03-03 20:39:58" itemprop="dateCreated datePublished" datetime="2025-03-03T20:39:58+08:00">2025-03-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-03-10 22:54:33" itemprop="dateModified" datetime="2025-03-10T22:54:33+08:00">2025-03-10</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="一、写在前面"><a href="#一、写在前面" class="headerlink" title="一、写在前面"></a>一、写在前面</h1><p>好久没有写技术文章了，今天，想给大家推荐一款我最近精心设计研发的代码安全分析扫描器，名叫Artemis。这款代码安全扫描器融合了经典的代码安全分析技术以及最新的大模型分析技术，能够帮助各位进行更加深入的代码安全分析工作，发现更多代码安全问题。(下载链接可从文末获取)</p>
<h1 id="二、Artemis静态代码分析技术栈：数据流、编译时捕获、控制流分析、漏洞分析、AI智能分析"><a href="#二、Artemis静态代码分析技术栈：数据流、编译时捕获、控制流分析、漏洞分析、AI智能分析" class="headerlink" title="二、Artemis静态代码分析技术栈：数据流、编译时捕获、控制流分析、漏洞分析、AI智能分析"></a>二、Artemis静态代码分析技术栈：数据流、编译时捕获、控制流分析、漏洞分析、AI智能分析</h1><h2 id="2-1-编译时捕获"><a href="#2-1-编译时捕获" class="headerlink" title="2.1 编译时捕获"></a>2.1 编译时捕获</h2><p>Artemis静态代码分析工具借鉴了coverity、codeql等一些知名代码安全分析工具的实现思路，采用编译时进行一些语义信息的捕获，比如类型推导信息。根据多年来的静态代码实践经验来看，静态代码分析的准确性，很大程度上和类型推导的准确性相关，尤其是在过程间分析的时候，如果不能够很好的识别函数所属对象的类型，那调用链构建方面将会有很大的误差。很多开源白盒基于ast遍历分析推导类型信息，这种方式的弊端是，一方面需要花费很多时间在解析程序的编写上，以适配很多的场景；另一方面，针对第三方库的函数，由于不能对其声明进行解析识别，导致我们单从源码层层面无法很准确的推断出他的函数签名信息，进而导致误报加剧。其实，编译器已经帮助我们推导了所需的大多数类型信息，而且他推导的准确性肯定是高于开源社区方案推导的准确性，因为编译器他推导不成功的话，那程序根本跑不起来。</p>
<h2 id="2-2-数据流及控制流"><a href="#2-2-数据流及控制流" class="headerlink" title="2.2 数据流及控制流"></a>2.2 数据流及控制流</h2><p>artemis在编译阶段，会基于提取的ast信息，构建项目代码的控制流信息，并基于此，进一步解析各个过程的数据流指向关系。所有编译时提取的语义信息都持久化存储在源码文件对应的编译产出物中。当然，这其中只涉及过程内的语义信息，至于过程间的语义信息，artemis是放在漏洞分析过程中进行动态分析的。</p>
<h2 id="2-3-漏洞分析"><a href="#2-3-漏洞分析" class="headerlink" title="2.3 漏洞分析"></a>2.3 漏洞分析</h2><p>针对漏洞分析方面，artemis的通用漏洞检测策略，比如针对数据流相关的漏洞检测方案，主要是通过规则定位相关的sink点和source点，然后基于数据流指向信息以及调用链信息推断source点到达sink点的可能路径，这一思路也会业内普遍使用的分析思路。为了实现这个方案，artemis参考了codeql及joern的查询脚本的设计思路，设计了一款属于artemis自己的ql语法，名叫artQL，安全工程师可通过artQL灵活的编写安全分析策略。<br>以下是Artemis漏洞分析的原理示意图<br><img src="/images/artemis.png" alt="artmis"></p>
<h2 id="2-4-AI智能分析"><a href="#2-4-AI智能分析" class="headerlink" title="2.4 AI智能分析"></a>2.4 AI智能分析</h2><p>Artemis一个比较亮眼的功能就是能够在规则层面提供直接调用大模型进行代码安全检测规则编写，发现更深层次的问题。具体实现原理以及应用实践，请移步第四个章节。</p>
<h1 id="三、artQL"><a href="#三、artQL" class="headerlink" title="三、artQL"></a>三、artQL</h1><p>为了让读者能够更易于理解后续的一些章节，我先简要的介绍下artQL的语法。下面是artQL比较重要的关键词：</p>
<table>
<thead>
<tr>
<th>关键字</th>
<th>说明</th>
<th>示例</th>
</tr>
</thead>
<tbody><tr>
<td>db</td>
<td>数据库，所有的数据都从这来</td>
<td></td>
</tr>
<tr>
<td>call</td>
<td>函数调用</td>
<td>db.call</td>
</tr>
<tr>
<td>method</td>
<td>函数声明</td>
<td>db.method</td>
</tr>
<tr>
<td>types</td>
<td>类型声明</td>
<td>db.types</td>
</tr>
<tr>
<td>xml</td>
<td>xml文件信息</td>
<td>db.xml</td>
</tr>
<tr>
<td>where</td>
<td>条件判断</td>
<td>db.call.where(_.name&#x3D;&#x3D;”niceshot”)</td>
</tr>
<tr>
<td>whereNot</td>
<td>条件判断</td>
<td>db.call.whereNot(_.name&#x3D;&#x3D;”nicejob”)</td>
</tr>
<tr>
<td>filter</td>
<td>条件过滤</td>
<td>db.call.filter(_.name&#x3D;&#x3D;”nicejob”)</td>
</tr>
<tr>
<td>limit</td>
<td>枚举限制，限制获取的节点数量</td>
<td>db.call.limit(10)</td>
</tr>
<tr>
<td>methodDeclaration</td>
<td>获取函数调用对应的函数声明信息</td>
<td>callExpr.methodDeclaration</td>
</tr>
<tr>
<td>hasPathTo</td>
<td>污点路径追踪</td>
<td>sink.hasPathTo(source)</td>
</tr>
<tr>
<td>以上是对于规则编写比较帮助的关键字信息，基于关键字信息介绍以及示例demo，相比你已经知道如何去编写一个基础的安全检测规则了，例如我们可以编写一个sql注入检测的规则：</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">val sources = db.call.where(_.fullName==&quot;javax.servlet.http.HttpServletRequest.getParameter&quot;)</span><br><span class="line">val sink=db.call.where(_.fullName==&quot;org.springframework.jdbc.core.JdbcTemplate.update&quot;).filter(_.arguments.nonEmpty).map(_.arguments.head)</span><br><span class="line">val paths=sink.hashPathTo(sources)</span><br><span class="line">paths.show //打印路径</span><br><span class="line">paths.num //统计路径数量</span><br></pre></td></tr></table></figure>
<h1 id="四、实际项目分析"><a href="#四、实际项目分析" class="headerlink" title="四、实际项目分析"></a>四、实际项目分析</h1><h2 id="4-1-通用漏洞分析-ofcms漏洞分析"><a href="#4-1-通用漏洞分析-ofcms漏洞分析" class="headerlink" title="4.1 通用漏洞分析 - ofcms漏洞分析"></a>4.1 通用漏洞分析 - ofcms漏洞分析</h2><h3 id="4-1-1-ofcms-sql注入分析"><a href="#4-1-1-ofcms-sql注入分析" class="headerlink" title="4.1.1 ofcms sql注入分析"></a>4.1.1 ofcms sql注入分析</h3><h4 id="漏洞说明"><a href="#漏洞说明" class="headerlink" title="漏洞说明"></a>漏洞说明</h4><p>是骡子是马，拿出来溜溜。下面我们来使用artQL来进行一些实际的安全问题的分析。我们就以ofcms这个项目来作为例子。<br>根据cve:<code>https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-9615</code> 描述，ofcms在1.1.3版本之前存在大量的sql注入漏洞。</p>
<h4 id="具体位置"><a href="#具体位置" class="headerlink" title="具体位置"></a>具体位置</h4><p>通过源码分析，我们发现ofcms是基于jfinal框架进行开发，且sql操作也是基于jfinal提供的api进行处理。例如：<br><code>ofcms-admin/src/main/java/com/ofsoft/cms/admin/controller/system/SystemGenerateController.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">create</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> getPara(<span class="string">&quot;sql&quot;</span>);</span><br><span class="line">            Db.update(sql);</span><br><span class="line">            rendSuccessJson();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            rendFailedJson(ErrorCode.get(<span class="string">&quot;9999&quot;</span>), e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该源码大致意思是从网络请求参数中获取sql参数，然后调用Db.update进行数据更新操作。<br>这个Db,通过跟踪分析，其全路径是：com.jfinal.plugin.activerecord.Db。<br>这里直接将外部传入的sql语句进行执行，很明显是存在sql注入漏洞的。那么如何用artemis检测该漏洞呢？我们可以编写如下规则：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">c-rule</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>dataflow-rule-sqli<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>sql注入漏洞<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">//示例 &amp;#xA;</span></span></span><br><span class="line"><span class="language-javascript">            def <span class="attr">sinks</span>:<span class="title class_">List</span>[<span class="title class_">Expr</span>]=db.<span class="property">call</span>.<span class="title function_">where</span>(_.<span class="property">fullName</span>==<span class="string">&quot;java.sql.Statement.executeQuery&quot;</span>).<span class="title function_">map</span>(_.<span class="property">arguments</span>.<span class="property">head</span>) &amp;#xA;</span></span><br><span class="line"><span class="language-javascript">            def sources = com.<span class="property">pony</span>.<span class="property">rule</span>.<span class="property">sources</span>.<span class="property">HttpSources</span>.<span class="property">http_entry</span> &amp;#xA;</span></span><br><span class="line"><span class="language-javascript">            def paths=sinks.<span class="title function_">hasPathTo</span>(sources) &amp;#xA;</span></span><br><span class="line"><span class="language-javascript">            paths.<span class="title function_">save</span>(name = <span class="string">&quot;sql注入漏洞&quot;</span>, desc = <span class="string">&quot;sql注入漏洞&quot;</span>,level = <span class="string">&quot;high&quot;</span>, rule_id = <span class="string">&quot;dataflow-rule-sqli&quot;</span>) &amp;#xA;</span></span><br><span class="line"><span class="language-javascript">        </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">c-rule</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>简单解读写规则，该规则中source点为jfinal框架的网络请求入口点getPara或getParamsMap，sink点是进行渲染操作的render函数，如果需要精确的识别api，可使用fullname指定api的全限定名。我们将规则加入到我们的Checker.xml规则文件中，然后下面我们正式进行代码分析测试。<br>首先，由于每一个项目需要的jdk和编译命令可能都不太一样，所以这里需要我们先配置下项目编译需要的相关参数。这个参数在conf目录下的build.properties中配置即可。<br>具体在build.properties文件中，我们重点关注以下配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">java_home=/Library/Java/JavaVirtualMachines/jdk1.8.0_151.jdk/Contents/Home</span><br><span class="line">report_output=report.json</span><br><span class="line">build_cmd= mvn package -X -DskipTests=true</span><br><span class="line">out_dir=workspace</span><br></pre></td></tr></table></figure>
<p>其中，java_home是我们jdk的地址，report_output是我们报告输出的地址，build_cmd是我们的项目编译命令，out_dir是中间语义数据库输出的目录<br>配置好后，下面我们执行以下命令即可进行编译捕获<br><img src="/images/p2.png" alt="捕获"><br><img src="/images/p1.png" alt="捕获"><br>从命令行执行日志可以发现，捕获449个源码大概耗时55秒，这个速度应该是可以接受的。<br>下面我们执行以下命令进行漏洞分析:<br><code>java -jar Artemis.jar -d workspace</code><br><img src="/images/p3.png" alt="分析"><br>可以发现Artemis共发现了43个sql注入漏洞，8个模版注入，两个文件操纵漏洞和一个文件上传漏洞。<br>其中我们刚才分析的那个sql注入漏洞的检测结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	&quot;name&quot;: &quot;sql注入漏洞&quot;,</span><br><span class="line">	&quot;checker_name&quot;: &quot;dataflow-rule-sqli&quot;,</span><br><span class="line">	&quot;trace&quot;: [&#123;</span><br><span class="line">		&quot;desc&quot;: &quot;&quot;,</span><br><span class="line">		&quot;line&quot;: 48,</span><br><span class="line">		&quot;code&quot;: &quot;sql&quot;,</span><br><span class="line">		&quot;filePath&quot;: &quot;/Users/pony/Desktop/release/1.0.0/test/ofcms-V1.1.2/ofcms-admin/src/main/java/com/ofsoft/cms/admin/controller/system/SystemGenerateController.java&quot;</span><br><span class="line">	&#125;, &#123;</span><br><span class="line">		&quot;desc&quot;: &quot;&quot;,</span><br><span class="line">		&quot;line&quot;: 47,</span><br><span class="line">		&quot;code&quot;: &quot;sql&quot;,</span><br><span class="line">		&quot;filePath&quot;: &quot;/Users/pony/Desktop/release/1.0.0/test/ofcms-V1.1.2/ofcms-admin/src/main/java/com/ofsoft/cms/admin/controller/system/SystemGenerateController.java&quot;</span><br><span class="line">	&#125;, &#123;</span><br><span class="line">		&quot;desc&quot;: &quot;&quot;,</span><br><span class="line">		&quot;line&quot;: 47,</span><br><span class="line">		&quot;code&quot;: &quot;getPara(\&quot;sql\&quot;)&quot;,</span><br><span class="line">		&quot;filePath&quot;: &quot;/Users/pony/Desktop/release/1.0.0/test/ofcms-V1.1.2/ofcms-admin/src/main/java/com/ofsoft/cms/admin/controller/system/SystemGenerateController.java&quot;</span><br><span class="line">	&#125;],</span><br><span class="line">	&quot;desc&quot;: &quot;                SQL注入（SQL Injection）是一种针对Web应用程序的攻击技术。具体来说，它是指web应用程序对用户输入数据的合法性没有判断或过滤不严，攻击者可以在web应用程序中事先定义好的查询语句的结尾上添加额外的SQL语句，在管理员不知情的情况下实现非法操作，以此来实现欺骗数据库服务器执行非授权的任意查询，从而进一步得到相应的数据信息。\u0026#xA;                SQL注入攻击通常利用了应用程序没有对用户输入数据进行充分验证和过滤的漏洞，使得攻击者可以将恶意的SQL语句注入到应用程序的输入框或URL中，从而绕过应用程序的身份验证和访问控制机制，进而执行恶意操作，如获取敏感数据、修改数据、删除数据等。\u0026#xA;            &quot;,</span><br><span class="line">	&quot;level&quot;: &quot;high&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-1-2-ofcms-模版注入漏洞分析"><a href="#4-1-2-ofcms-模版注入漏洞分析" class="headerlink" title="4.1.2 ofcms 模版注入漏洞分析"></a>4.1.2 ofcms 模版注入漏洞分析</h3><p>上个章节中，我们在使用Artemis对ofcms项目进行sql注入扫描的时候，发现在扫描的过程中也发现了一些服务端模版注入漏洞。通过对报告的review，发现主要问题集中在文件<code>com/ofsoft/cms/front/controller/IndexController.java</code>及<code>com/ofsoft/cms/front/controller/ComnController.java</code>中，下面我们以IndexController.java中的ssti漏洞为例子，讲解下Artemis是如何发现这个漏洞的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br></pre></td><td class="code"><pre><span class="line">package com.ofsoft.cms.front.controller;</span><br><span class="line"></span><br><span class="line">import com.jfinal.core.ActionKey;</span><br><span class="line">import com.jfinal.plugin.activerecord.Record;</span><br><span class="line">import com.ofsoft.cms.core.annotation.Action;</span><br><span class="line">import com.ofsoft.cms.core.config.AdminConst;</span><br><span class="line">import com.ofsoft.cms.core.config.FrontConst;</span><br><span class="line">import com.ofsoft.cms.core.uitle.SiteUtile;</span><br><span class="line"></span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 页面配置</span><br><span class="line"> *</span><br><span class="line"> * @author OF</span><br><span class="line"> * @date 2018年1月2日</span><br><span class="line"> */</span><br><span class="line">@Action()</span><br><span class="line">public class IndexController extends BaseController &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 首页页面</span><br><span class="line">     */</span><br><span class="line">    @ActionKey(value = &quot;index&quot;)</span><br><span class="line">    public void front() &#123;</span><br><span class="line">        render(FrontConst.TEMPLATE_PATE + SiteUtile.getTemplatePath() + &quot;/index.html&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 管理台首页默认跳转</span><br><span class="line">     */</span><br><span class="line">    @ActionKey(value = &quot;/admin&quot;)</span><br><span class="line">    public void admin() &#123;</span><br><span class="line">        redirect(AdminConst.indexHtml);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 首页面配置</span><br><span class="line">     */</span><br><span class="line">    @ActionKey(value = &quot;/&quot;)</span><br><span class="line">    public void index() &#123;</span><br><span class="line">        Map params = getParamsMap();</span><br><span class="line">        String page = getPara(0);</span><br><span class="line">        //是否是首页</span><br><span class="line">        if (&quot;/&quot;.equals(page) || page == null || &quot;index&quot;.equals(page)) &#123;</span><br><span class="line">            setAttr(&quot;site&quot;, SiteUtile.getSite());</span><br><span class="line">            render(FrontConst.TEMPLATE_PATE + SiteUtile.getTemplatePath() + &quot;/index.html&quot;);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        //获取当前栏目</span><br><span class="line">        params.put(&quot;site_id&quot;, SiteUtile.getSiteId());</span><br><span class="line">        params.put(&quot;column_english&quot;, page);</span><br><span class="line">        params.put(&quot;page&quot;, page);</span><br><span class="line">        Record record = SiteUtile.getColumn(params);</span><br><span class="line">        String isContent = getPara(1);</span><br><span class="line">        if (record == null) &#123;</span><br><span class="line">            if (&quot;c&quot;.equals(isContent)) &#123;</span><br><span class="line">                params.put(&quot;content_id&quot;, getParaToInt(2, 0));</span><br><span class="line">                setAttr(&quot;params&quot;, params);</span><br><span class="line">                render(FrontConst.TEMPLATE_PATE + SiteUtile.getTemplatePath() + &quot;/article.html&quot;);</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            render(FrontConst.TEMPLATE_PATE + SiteUtile.getTemplatePath() + FrontConst.pageError);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        setAttr(&quot;columns&quot;, record);</span><br><span class="line">        setAttr(&quot;params&quot;, params);</span><br><span class="line">        //是否是内容</span><br><span class="line">        if (&quot;c&quot;.equals(isContent)) &#123;</span><br><span class="line">            params.put(&quot;content_id&quot;, getParaToInt(2, 0));</span><br><span class="line">            String templatePath = SiteUtile.getTemplatePath(record.getStr(&quot;column_content_page&quot;), &quot;/article.html&quot;);</span><br><span class="line">            render(FrontConst.TEMPLATE_PATE + SiteUtile.getTemplatePath() + templatePath);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        //是否是单页</span><br><span class="line">        if (&quot;1&quot;.equals(record.getStr(&quot;is_open&quot;))) &#123;</span><br><span class="line">            String templatePath = SiteUtile.getTemplatePath(record.getStr(&quot;template_path&quot;), &quot;/sing.html&quot;);</span><br><span class="line">            render(FrontConst.TEMPLATE_PATE + SiteUtile.getTemplatePath() + templatePath);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        //当前页码 栏目页</span><br><span class="line">        int pageNum = getParaToInt(1, 1);</span><br><span class="line">        setAttr(&quot;pageNum&quot;, pageNum);</span><br><span class="line">        String templatePath = SiteUtile.getTemplatePath(record.getStr(&quot;template_path&quot;), &quot;/list.html&quot;);</span><br><span class="line">        render(FrontConst.TEMPLATE_PATE + SiteUtile.getTemplatePath() + templatePath);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 列表页面</span><br><span class="line">     */</span><br><span class="line">    @ActionKey(value = &quot;/list&quot;)</span><br><span class="line">    public void list() &#123;</span><br><span class="line">        render(FrontConst.TEMPLATE_PATE + SiteUtile.getTemplatePath() + &quot;/list.html&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 内容页面</span><br><span class="line">     */</span><br><span class="line">    @ActionKey(value = &quot;/content&quot;)</span><br><span class="line">    public void content() &#123;</span><br><span class="line">        String p = getRequest().getRequestURI();</span><br><span class="line">        p = p.replace(getRequest().getContextPath(), &quot;&quot;).replace(&quot;/content&quot;, &quot;&quot;);</span><br><span class="line">        render(FrontConst.TEMPLATE_PATE + SiteUtile.getTemplatePath() + p);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 栏目页面</span><br><span class="line">     */</span><br><span class="line">    @ActionKey(value = &quot;/column&quot;)</span><br><span class="line">    public void column() &#123;</span><br><span class="line">        Map params = getParamsMap();</span><br><span class="line">        String page = getPara(0);</span><br><span class="line">        //当前页码</span><br><span class="line">        int pageNum = getParaToInt(1, 1);</span><br><span class="line">        //获取当前栏目</span><br><span class="line">        params.put(&quot;site_id&quot;, SiteUtile.getSiteId());</span><br><span class="line">        params.put(&quot;column_english&quot;, page);</span><br><span class="line">        params.put(&quot;page&quot;, page);</span><br><span class="line">        Record record = SiteUtile.getColumn(params);</span><br><span class="line">        setAttr(&quot;columns&quot;, record);</span><br><span class="line">        setAttr(&quot;params&quot;, params);</span><br><span class="line">        setAttr(&quot;pageNum&quot;, pageNum);</span><br><span class="line">        String templatePath = record.getStr(&quot;template_path&quot;);</span><br><span class="line">        if (templatePath == null) &#123;</span><br><span class="line">            templatePath = &quot;index.html&quot;;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            if (!templatePath.startsWith(&quot;/&quot;)) &#123;</span><br><span class="line">                templatePath = &quot;/&quot; + templatePath;</span><br><span class="line">            &#125;</span><br><span class="line">            if (!templatePath.endsWith(&quot;.html&quot;)) &#123;</span><br><span class="line">                templatePath = templatePath + &quot;.html&quot;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        render(FrontConst.TEMPLATE_PATE + SiteUtile.getTemplatePath() + templatePath);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 普通页面</span><br><span class="line">     */</span><br><span class="line">    @ActionKey(value = &quot;/news&quot;)</span><br><span class="line">    public void news() &#123;</span><br><span class="line">        String p = getRequest().getRequestURI();</span><br><span class="line">        p = p.replace(getRequest().getContextPath(), &quot;&quot;).replace(&quot;/page&quot;, &quot;&quot;);</span><br><span class="line">        render(FrontConst.TEMPLATE_PATE + SiteUtile.getTemplatePath() + p);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 页面配置</span><br><span class="line">     */</span><br><span class="line">    @ActionKey(value = &quot;page&quot;)</span><br><span class="line">    public void page() &#123;</span><br><span class="line">        String s = getPara(&quot;s&quot;);</span><br><span class="line">        if (s.lastIndexOf(&quot;.html&quot;) != 0) &#123;</span><br><span class="line">            s = s + &quot;.html&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        setAttr(&quot;params&quot;, getParamsMap());</span><br><span class="line">        render(FrontConst.TEMPLATE_PATE + SiteUtile.getTemplatePath() + s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>通过源码分析，很显然，此处的ssti注入漏洞的是误报的，因为其并不能直接控制ssti模版内容，只能控制选择哪一个ssti模版。<br>我们看下我们之前的artQL规则是怎么写的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;c-rule&gt;</span><br><span class="line">    &lt;id&gt;dataflow-rule-ssti-ofcms&lt;/id&gt;</span><br><span class="line">    &lt;name&gt;ssti注入漏洞&lt;/name&gt;</span><br><span class="line">    &lt;enabled&gt;true&lt;/enabled&gt;</span><br><span class="line">    &lt;script&gt;</span><br><span class="line">        &lt;![CDATA[</span><br><span class="line">            def source=com.pony.rule.sources.HttpSources.http_entry &lt;br&gt;</span><br><span class="line">            def sink=db.call.where(_.name==&quot;render&quot;).filter(_.arguments.nonEmpty).map(_.arguments.head) &lt;br&gt;</span><br><span class="line">            def paths=sink.hasPathTo(source) &lt;br&gt;</span><br><span class="line">            paths.save(name = &quot;ssti注入漏洞&quot;, desc = &quot;ssti注入漏洞&quot;,level = &quot;high&quot;, rule_id = &quot;dataflow-rule-ssti-ofcms&quot;) &lt;br&gt;</span><br><span class="line">        ]]&gt;</span><br><span class="line">    &lt;/script&gt;</span><br><span class="line">&lt;/c-rule&gt;</span><br></pre></td></tr></table></figure>
<p>只进行了简单的数据流路径推断，没有更深入分析其传入的内容是否能够真正构成漏洞。<br>我们在原来的规则上进行进一步改造,增加一些文件上传逻辑的搜索，另外我们还需要将两者进行适当的关联比对，以减少误报的产生</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">&lt;![CDATA[</span><br><span class="line">                    def source=com.pony.rule.sources.HttpSources.http_entry &lt;br&gt;</span><br><span class="line">                    def sink=db.call.where(_.name==&quot;render&quot;).filter(_.arguments.nonEmpty).map(_.arguments.head) &lt;br&gt;</span><br><span class="line">                    def paths=sink.hasPathTo(source) &lt;br&gt;</span><br><span class="line">                    val sink_file_upload= db.call.where &#123; &lt;br&gt;</span><br><span class="line">                      it =&gt; &lt;br&gt;</span><br><span class="line">                        it.fullName == &quot;java.nio.file.Files.write&quot; &lt;br&gt;</span><br><span class="line">                          || it.fullName == &quot;java.io.FileOutputStream.write&quot; &lt;br&gt;</span><br><span class="line">                    &#125;.filter(_.arguments.nonEmpty).map(_.arguments.head) &lt;br&gt;</span><br><span class="line">                    val paths_file_upload=sink_file_upload.hasPathTo(sources = source) &lt;br&gt;</span><br><span class="line">                    val final_path:ListBuffer[Path]=new ListBuffer[Path] &lt;br&gt;</span><br><span class="line">                    if(paths.nonEmpty)&#123; &lt;br&gt;</span><br><span class="line">                      paths.foreach&#123; &lt;br&gt;</span><br><span class="line">                        it=&gt;&#123; &lt;br&gt;</span><br><span class="line">                          val target:ListBuffer[AST]=new ListBuffer[AST] &lt;br&gt;</span><br><span class="line">                          val head_node=it.nodes.head &lt;br&gt;</span><br><span class="line">                          //提取其中的符号信息 &lt;br&gt;</span><br><span class="line">                          val t=head_node.parent.node &lt;br&gt;</span><br><span class="line">                          if(t.nonEmpty) &#123; &lt;br&gt;</span><br><span class="line">                            com.pony.dataflow.DataFlowAnalyze.find_target_expr(start = t.get, expr_Type = &quot;NameExpr&quot;, targets = target) &lt;br&gt;</span><br><span class="line">                            Breaks.breakable &#123; &lt;br&gt;</span><br><span class="line">                              target.foreach &#123; &lt;br&gt;</span><br><span class="line">                                t =&gt; &#123; &lt;br&gt;</span><br><span class="line">                                  val t_name = t.asInstanceOf[NameExpr].name &lt;br&gt;</span><br><span class="line">                                  //对于每个文件上传流 &lt;br&gt;</span><br><span class="line">                                  val filtered_paths = paths_file_upload.filter &#123; &lt;br&gt;</span><br><span class="line">                                    l =&gt; &#123; &lt;br&gt;</span><br><span class="line">                                      l.nodes.count(_.code.contains(t_name)) &gt; 0 &lt;br&gt;</span><br><span class="line">                                    &#125; &lt;br&gt;</span><br><span class="line">                                  &#125; &lt;br&gt;</span><br><span class="line">                                  if (filtered_paths.nonEmpty) &#123; &lt;br&gt;</span><br><span class="line">                                    filtered_paths.foreach &#123; &lt;br&gt;</span><br><span class="line">                                      f =&gt; &#123; &lt;br&gt;</span><br><span class="line">                                        val p=new Path() &lt;br&gt;</span><br><span class="line">                                        p.nodes.addAll(f.nodes.reverse++it.nodes.reverse) &lt;br&gt;</span><br><span class="line">                                        final_path.addOne(p) &lt;br&gt;</span><br><span class="line">                                      &#125; &lt;br&gt;</span><br><span class="line">                                    &#125; &lt;br&gt;</span><br><span class="line">                                    Breaks.break() &lt;br&gt;</span><br><span class="line">                                  &#125; &lt;br&gt;</span><br><span class="line">                                &#125; &lt;br&gt;</span><br><span class="line">                              &#125; &lt;br&gt;</span><br><span class="line">                            &#125; &lt;br&gt;</span><br><span class="line">                          &#125; &lt;br&gt;</span><br><span class="line">                        &#125; &lt;br&gt;</span><br><span class="line">                      &#125; &lt;br&gt;</span><br><span class="line">                    &#125; &lt;br&gt;</span><br><span class="line">                    final_path.toList.save(name = &quot;ssti注入漏洞&quot;, desc = &quot;ssti注入漏洞&quot;,level = &quot;high&quot;, rule_id = &quot;dataflow-rule-ssti-ofcms&quot;) &lt;br&gt;</span><br><span class="line">                ]]&gt;</span><br></pre></td></tr></table></figure>
<p>简单的描述下规则逻辑，第一步获取前面的那个ssti漏洞检测规则的路径，然后再获取项目中存在的文件上传数据流，然后通过关联分析，将两者路径进行merge。<br>下面是改造后的规则扫描的结果路径</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ssti注入漏洞&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;checker_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;dataflow-rule-ssti-ofcms&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;trace&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;desc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="attr">&quot;line&quot;</span><span class="punctuation">:</span> <span class="number">121</span><span class="punctuation">,</span></span><br><span class="line">		<span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="string">&quot;getRequest().getParameter(\&quot;file_content\&quot;)&quot;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="attr">&quot;filePath&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/Users/pony/Desktop/release/1.0.0/test/ofcms-V1.1.2/ofcms-admin/src/main/java/com/ofsoft/cms/admin/controller/cms/TemplateController.java&quot;</span></span><br><span class="line">	<span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;desc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="attr">&quot;line&quot;</span><span class="punctuation">:</span> <span class="number">121</span><span class="punctuation">,</span></span><br><span class="line">		<span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="string">&quot;fileContent&quot;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="attr">&quot;filePath&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/Users/pony/Desktop/release/1.0.0/test/ofcms-V1.1.2/ofcms-admin/src/main/java/com/ofsoft/cms/admin/controller/cms/TemplateController.java&quot;</span></span><br><span class="line">	<span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;desc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="attr">&quot;line&quot;</span><span class="punctuation">:</span> <span class="number">122</span><span class="punctuation">,</span></span><br><span class="line">		<span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="string">&quot;fileContent&quot;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="attr">&quot;filePath&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/Users/pony/Desktop/release/1.0.0/test/ofcms-V1.1.2/ofcms-admin/src/main/java/com/ofsoft/cms/admin/controller/cms/TemplateController.java&quot;</span></span><br><span class="line">	<span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;desc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="attr">&quot;line&quot;</span><span class="punctuation">:</span> <span class="number">122</span><span class="punctuation">,</span></span><br><span class="line">		<span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="string">&quot;fileContent&quot;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="attr">&quot;filePath&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/Users/pony/Desktop/release/1.0.0/test/ofcms-V1.1.2/ofcms-admin/src/main/java/com/ofsoft/cms/admin/controller/cms/TemplateController.java&quot;</span></span><br><span class="line">	<span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;desc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="attr">&quot;line&quot;</span><span class="punctuation">:</span> <span class="number">124</span><span class="punctuation">,</span></span><br><span class="line">		<span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="string">&quot;fileContent&quot;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="attr">&quot;filePath&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/Users/pony/Desktop/release/1.0.0/test/ofcms-V1.1.2/ofcms-admin/src/main/java/com/ofsoft/cms/admin/controller/cms/TemplateController.java&quot;</span></span><br><span class="line">	<span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;desc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="attr">&quot;line&quot;</span><span class="punctuation">:</span> <span class="number">74</span><span class="punctuation">,</span></span><br><span class="line">		<span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="string">&quot;String string&quot;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="attr">&quot;filePath&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/Users/pony/Desktop/release/1.0.0/test/ofcms-V1.1.2/ofcms-admin/src/main/java/com/ofsoft/cms/core/uitle/FileUtils.java&quot;</span></span><br><span class="line">	<span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;desc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="attr">&quot;line&quot;</span><span class="punctuation">:</span> <span class="number">78</span><span class="punctuation">,</span></span><br><span class="line">		<span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="string">&quot;string&quot;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="attr">&quot;filePath&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/Users/pony/Desktop/release/1.0.0/test/ofcms-V1.1.2/ofcms-admin/src/main/java/com/ofsoft/cms/core/uitle/FileUtils.java&quot;</span></span><br><span class="line">	<span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;desc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="attr">&quot;line&quot;</span><span class="punctuation">:</span> <span class="number">154</span><span class="punctuation">,</span></span><br><span class="line">		<span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="string">&quot;getPara(\&quot;s\&quot;)&quot;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="attr">&quot;filePath&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/Users/pony/Desktop/release/1.0.0/test/ofcms-V1.1.2/ofcms-admin/src/main/java/com/ofsoft/cms/front/controller/IndexController.java&quot;</span></span><br><span class="line">	<span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;desc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="attr">&quot;line&quot;</span><span class="punctuation">:</span> <span class="number">154</span><span class="punctuation">,</span></span><br><span class="line">		<span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="string">&quot;s&quot;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="attr">&quot;filePath&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/Users/pony/Desktop/release/1.0.0/test/ofcms-V1.1.2/ofcms-admin/src/main/java/com/ofsoft/cms/front/controller/IndexController.java&quot;</span></span><br><span class="line">	<span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;desc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="attr">&quot;line&quot;</span><span class="punctuation">:</span> <span class="number">156</span><span class="punctuation">,</span></span><br><span class="line">		<span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="string">&quot;s&quot;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="attr">&quot;filePath&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/Users/pony/Desktop/release/1.0.0/test/ofcms-V1.1.2/ofcms-admin/src/main/java/com/ofsoft/cms/front/controller/IndexController.java&quot;</span></span><br><span class="line">	<span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;desc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="attr">&quot;line&quot;</span><span class="punctuation">:</span> <span class="number">156</span><span class="punctuation">,</span></span><br><span class="line">		<span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="string">&quot;s&quot;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="attr">&quot;filePath&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/Users/pony/Desktop/release/1.0.0/test/ofcms-V1.1.2/ofcms-admin/src/main/java/com/ofsoft/cms/front/controller/IndexController.java&quot;</span></span><br><span class="line">	<span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="punctuation">&#123;</span></span><br><span class="line">		<span class="attr">&quot;desc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="attr">&quot;line&quot;</span><span class="punctuation">:</span> <span class="number">159</span><span class="punctuation">,</span></span><br><span class="line">		<span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="string">&quot;FrontConst.TEMPLATE_PATE + SiteUtile.getTemplatePath() + s&quot;</span><span class="punctuation">,</span></span><br><span class="line">		<span class="attr">&quot;filePath&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/Users/pony/Desktop/release/1.0.0/test/ofcms-V1.1.2/ofcms-admin/src/main/java/com/ofsoft/cms/front/controller/IndexController.java&quot;</span></span><br><span class="line">	<span class="punctuation">&#125;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;desc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ssti注入漏洞&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;level&quot;</span><span class="punctuation">:</span> <span class="string">&quot;high&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>这个路径作为漏洞存在就比较有说服力了。<br>这里查找出来的文件上传点是</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 保存模板</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">resPath</span> <span class="operator">=</span> getPara(<span class="string">&quot;res_path&quot;</span>);</span><br><span class="line">        <span class="type">File</span> <span class="variable">pathFile</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;res&quot;</span>.equals(resPath))&#123;</span><br><span class="line">            pathFile = <span class="keyword">new</span> <span class="title class_">File</span>(SystemUtile.getSiteTemplateResourcePath());</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            pathFile = <span class="keyword">new</span> <span class="title class_">File</span>(SystemUtile.getSiteTemplatePath());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">dirName</span> <span class="operator">=</span> getPara(<span class="string">&quot;dirs&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (dirName != <span class="literal">null</span>) &#123;</span><br><span class="line">            pathFile = <span class="keyword">new</span> <span class="title class_">File</span>(pathFile, dirName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> getPara(<span class="string">&quot;file_name&quot;</span>);</span><br><span class="line">        <span class="comment">// 没有用getPara原因是，getPara因为安全问题会过滤某些html元素。</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">fileContent</span> <span class="operator">=</span> getRequest().getParameter(<span class="string">&quot;file_content&quot;</span>);</span><br><span class="line">        fileContent = fileContent.replace(<span class="string">&quot;&amp;lt;&quot;</span>, <span class="string">&quot;&lt;&quot;</span>).replace(<span class="string">&quot;&amp;gt;&quot;</span>, <span class="string">&quot;&gt;&quot;</span>);</span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(pathFile, fileName);</span><br><span class="line">        FileUtils.writeString(file, fileContent);</span><br><span class="line">        rendSuccessJson();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>很明显，这里是存在ssti漏洞的，漏洞发生的逻辑是用户上传模版文件，然后保存在服务端的模版目录下，然后在后续的渲染执行过程中，根据不同的业务场景调用不同的模版执行。这样，整体的漏洞发生的脉络就很清楚了。</p>
<h2 id="4-2-逻辑漏洞分析-基于ai"><a href="#4-2-逻辑漏洞分析-基于ai" class="headerlink" title="4.2 逻辑漏洞分析(基于ai)"></a>4.2 逻辑漏洞分析(基于ai)</h2><h3 id="4-2-1-newbee-mall-垂直越权漏洞"><a href="#4-2-1-newbee-mall-垂直越权漏洞" class="headerlink" title="4.2.1 newbee mall 垂直越权漏洞"></a>4.2.1 newbee mall 垂直越权漏洞</h3><p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/newbee-ltd/newbee-mall">https://github.com/newbee-ltd/newbee-mall</a><br>我们先来看下这个项目的权限认证逻辑是什么样的。<br>首先开发者使用了spring security框架对用户的请求进行鉴权，权限配置类为：<br>NeeBeeMallWebMvcConfigurer.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> ltd.newbee.mall.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ltd.newbee.mall.common.Constants;</span><br><span class="line"><span class="keyword">import</span> ltd.newbee.mall.interceptor.AdminLoginInterceptor;</span><br><span class="line"><span class="keyword">import</span> ltd.newbee.mall.interceptor.NewBeeMallCartNumberInterceptor;</span><br><span class="line"><span class="keyword">import</span> ltd.newbee.mall.interceptor.NewBeeMallLoginInterceptor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.InterceptorRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.ResourceHandlerRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NeeBeeMallWebMvcConfigurer</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AdminLoginInterceptor adminLoginInterceptor;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> NewBeeMallLoginInterceptor newBeeMallLoginInterceptor;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> NewBeeMallCartNumberInterceptor newBeeMallCartNumberInterceptor;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> &#123;</span><br><span class="line">        <span class="comment">// 添加一个拦截器，拦截以/admin为前缀的url路径（后台登陆拦截）</span></span><br><span class="line">        registry.addInterceptor(adminLoginInterceptor)</span><br><span class="line">                .addPathPatterns(<span class="string">&quot;/admin/**&quot;</span>)</span><br><span class="line">                .excludePathPatterns(<span class="string">&quot;/admin/login&quot;</span>)</span><br><span class="line">                .excludePathPatterns(<span class="string">&quot;/admin/dist/**&quot;</span>)</span><br><span class="line">                .excludePathPatterns(<span class="string">&quot;/admin/plugins/**&quot;</span>);</span><br><span class="line">        <span class="comment">// 购物车中的数量统一处理</span></span><br><span class="line">        registry.addInterceptor(newBeeMallCartNumberInterceptor)</span><br><span class="line">                .excludePathPatterns(<span class="string">&quot;/admin/**&quot;</span>)</span><br><span class="line">                .excludePathPatterns(<span class="string">&quot;/register&quot;</span>)</span><br><span class="line">                .excludePathPatterns(<span class="string">&quot;/login&quot;</span>)</span><br><span class="line">                .excludePathPatterns(<span class="string">&quot;/logout&quot;</span>);</span><br><span class="line">        <span class="comment">// 商城页面登陆拦截</span></span><br><span class="line">        registry.addInterceptor(newBeeMallLoginInterceptor)</span><br><span class="line">                .excludePathPatterns(<span class="string">&quot;/admin/**&quot;</span>)</span><br><span class="line">                .excludePathPatterns(<span class="string">&quot;/register&quot;</span>)</span><br><span class="line">                .excludePathPatterns(<span class="string">&quot;/login&quot;</span>)</span><br><span class="line">                .excludePathPatterns(<span class="string">&quot;/logout&quot;</span>)</span><br><span class="line">                .addPathPatterns(<span class="string">&quot;/goods/detail/**&quot;</span>)</span><br><span class="line">                .addPathPatterns(<span class="string">&quot;/shop-cart&quot;</span>)</span><br><span class="line">                .addPathPatterns(<span class="string">&quot;/shop-cart/**&quot;</span>)</span><br><span class="line">                .addPathPatterns(<span class="string">&quot;/saveOrder&quot;</span>)</span><br><span class="line">                .addPathPatterns(<span class="string">&quot;/orders&quot;</span>)</span><br><span class="line">                .addPathPatterns(<span class="string">&quot;/orders/**&quot;</span>)            </span><br><span class="line">                .addPathPatterns(<span class="string">&quot;/personal&quot;</span>)</span><br><span class="line">                .addPathPatterns(<span class="string">&quot;/personal/updateInfo&quot;</span>)</span><br><span class="line">                .addPathPatterns(<span class="string">&quot;/selectPayType&quot;</span>)</span><br><span class="line">                .addPathPatterns(<span class="string">&quot;/payPage&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addResourceHandlers</span><span class="params">(ResourceHandlerRegistry registry)</span> &#123;</span><br><span class="line">        registry.addResourceHandler(<span class="string">&quot;/upload/**&quot;</span>).addResourceLocations(<span class="string">&quot;file:&quot;</span> + Constants.FILE_UPLOAD_DIC);</span><br><span class="line">        registry.addResourceHandler(<span class="string">&quot;/goods-img/**&quot;</span>).addResourceLocations(<span class="string">&quot;file:&quot;</span> + Constants.FILE_UPLOAD_DIC);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在NeeBeeMallWebMvcConfigurer类中，定义了多个拦截器，针对用户的url请求路径进行权限校验。其中&#x2F;admin&#x2F;开头的路由都会被转发到adminLoginInterceptor这个admin权限校验类中进行校验。下面我们来看下adminLoginInterceptor这个类的具体校验逻辑：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AdminLoginInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object o)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">requestServletPath</span> <span class="operator">=</span> request.getRequestURI();</span><br><span class="line">        <span class="keyword">if</span> (requestServletPath.startsWith(<span class="string">&quot;/admin&quot;</span>) &amp;&amp; <span class="literal">null</span> == request.getSession().getAttribute(<span class="string">&quot;loginUser&quot;</span>)) &#123;</span><br><span class="line">            request.getSession().setAttribute(<span class="string">&quot;errorMsg&quot;</span>, <span class="string">&quot;请登陆&quot;</span>);</span><br><span class="line">            response.sendRedirect(request.getContextPath() + <span class="string">&quot;/admin/login&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            request.getSession().removeAttribute(<span class="string">&quot;errorMsg&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">postHandle</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object o, ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object o, Exception e)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们先简要的分析下这个代码逻辑：代码中通过request.getRequestURI获取请求的url信息，然后判断下url中是否包含&#x2F;admin路由以及session中是否包含loginUser来判断其是否应该走到if的then分支中，如果if条件满足，则说明路由访问非法，需要重新登陆，反之则权限认证成功，可以执行该操作。<br>这里很明显是存在权限绕过缺陷的，因为我们使用的是request.getRequestURI获取的路由信息，我们知道通过request.getRequestURI获取的是用户原始的请求路由信息，用户原始的用户请求路由如果没有经过一些处理容易有url路径穿越的风险，例如我们构造：&#x2F;index&#x2F;..;&#x2F;admin这类的路径穿越的路由即可绕过if的条件判断。<br>下面我们来研究下怎么规则来识别这类问题。首先，我们有一个问题，我们怎么知道这是个需要admin权限访问的路由呢？如果我们无法准确识别admin权限路由，那我们的越权分析也就无从谈起。一般来说，我们在规则层面会通过路由特征来识别，但是这个方式有点蹩脚，而且这种特征识别肯定无法非常准确的识别的。其次，我们怎么去识别条件判断逻辑是可以进行绕过的呢？<br>上述的admin拦截器代码很简单，只是在if逻辑中判断了下是否路由是以&#x2F;admin开头。理论上来说，我们是可以写个简单规则去启发下扫描器，让它知道startswith是用于判断A字符串是否以B字符串作为起始。startswith中的字符串我们也可以获取其常量值。但是要是它不用startswith呢？用正则匹配呢？或则其他的一些判断方式呢？那我们的规则层的识别难度就很大了。那有什么办法可以比较好的处理这些问题呢？最近两年大模型逐渐火起来了，那么我们是否可以通过大模型来帮助我们处理这些涉及逻辑推理的一些问题呢？说干就干，目前Artemis已支持基于大模型的漏洞分析模块，只需要在规则编写的进行api调用即可。具体可能需要一些配置处理。主要是build.properties文件中的这几个配置项：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">model_name=deepseek-ai/DeepSeek-V2.5</span><br><span class="line">max_token=512</span><br><span class="line">temperature=0.7</span><br><span class="line">top_p=0.7</span><br><span class="line">top_k=50</span><br><span class="line">frequency_penalty=0.5</span><br><span class="line">n=1</span><br><span class="line">model_api=https://api.siliconflow.cn/v1/chat/completions</span><br></pre></td></tr></table></figure>
<p>model_api是我们对接的线上大模型平台地址(我的邀请码是：RHiwUmRu)，要使用大模型功能，你需要先去siliconflow这个平台注册一个帐号(新用户有2000w的免费token)，然后，你需要将你的api-token作为参数传入到大模型分析模块中，具体怎么用后面会说到。model_name是我们指定的模型名称，这里我选择的是免费的deepseek-ai&#x2F;DeepSeek-V2.5，当然你的预算充足也可以使用满血版的。其他参数可根据具体需求进行调整，这里不再赘述。<br>下面，我们用artQL来编写一个越权漏洞识别模块，来识别下这类的在拦截器中存在权限校验缺陷的问题。下面是我们的越权检测规则</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">c-rule</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>ai-overstep-rule2<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>越权漏洞<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">                &lt;![<span class="variable constant_">CDATA</span>[</span></span><br><span class="line"><span class="language-javascript">                    <span class="title function_">println</span>(<span class="string">&quot;ai-overstep-rule2 analyze start&quot;</span>) &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">                    val <span class="attr">knowledge</span>:<span class="title class_">String</span> = <span class="string">&quot;/index/..;/admin这类的路由会被getRequestURI识别为/index/..;/admin，可能会绕过一些拦截器的逻辑判断，应使用getServletPath进行获取。&quot;</span> &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">                    val <span class="attr">system_prompt</span>:<span class="title class_">String</span> = <span class="string">&quot;你是一个资深的代码安全分析专家，请深入分析以下代码的安全性，并给出修复方案(尽量简短)。回复内容的最后一个中文字请用于标记是否误报，若误报则标&#x27;假&#x27;，反之&#x27;真&#x27;。&quot;</span> &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">                    val md_interceptor_handler = db.<span class="property">method</span>.<span class="title function_">where</span>(_.<span class="property">name</span> == <span class="string">&quot;preHandle&quot;</span>).<span class="property">where</span>&#123; &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">                      <span class="function"><span class="params">it</span>=&gt;</span>&#123; &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">                        it.<span class="property">params</span>.<span class="title function_">count</span>(_.<span class="property">typeName</span>==<span class="string">&quot;HttpServletRequest&quot;</span>)&gt;<span class="number">0</span> &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">                      &#125; &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">                    &#125; &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">                    val md_interceptor_config = db.<span class="property">method</span>.<span class="title function_">where</span>(_.<span class="property">name</span> == <span class="string">&quot;addInterceptors&quot;</span>).<span class="property">where</span>&#123; &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">                      <span class="function"><span class="params">it</span>=&gt;</span>&#123; &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">                        it.<span class="property">params</span>.<span class="title function_">count</span>(_.<span class="property">typeName</span> == <span class="string">&quot;InterceptorRegistry&quot;</span>)&gt;<span class="number">0</span> &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">                      &#125; &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">                    &#125; &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">if</span>(md_interceptor_config.<span class="property">nonEmpty</span> &amp;&amp; md_interceptor_handler.<span class="property">nonEmpty</span>) &#123; &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">                      val pt = <span class="keyword">new</span> <span class="title class_">PromptTPL</span>() &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">                      pt.<span class="property">user_prompt</span> = s<span class="string">&quot;请问以下代码存在越权漏洞吗？\n$&#123;md_interceptor_handler.head.code&#125;&quot;</span> &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">                      pt.<span class="property">knowledge_prompt</span> = knowledge &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">                      pt.<span class="property">system_prompt</span> = system_prompt &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">                      pt.<span class="property">token</span> = <span class="title class_">Source</span>.<span class="title function_">fromFile</span>(<span class="string">&quot;/Users/pony/Desktop/zsd/工作资料/data/api_secrete.txt&quot;</span>).<span class="property">mkString</span> &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">                      val res = pt.<span class="property">query</span>.<span class="property">content</span> &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">                      <span class="keyword">if</span>(res.<span class="property">nonEmpty</span>) &#123; &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">                        <span class="keyword">if</span>(res.<span class="property">get</span>.<span class="title function_">endsWith</span>(<span class="string">&quot;真&quot;</span>))&#123; &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">                          <span class="title function_">println</span>(<span class="string">&quot;发现漏洞&quot;</span>) &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">                          <span class="title class_">Report</span>.<span class="property">flaws</span>.<span class="title function_">addOne</span>(<span class="keyword">new</span> <span class="title function_">FLAW</span>( &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">                            name = <span class="string">&quot;越权漏洞&quot;</span>, checker_name = <span class="string">&quot;ai-overstep-rule1&quot;</span>, &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">                            trace = <span class="title class_">Array</span>.<span class="property">empty</span>, desc = res.<span class="property">get</span>, level = <span class="string">&quot;high&quot;</span> &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">                          )) &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">                        &#125; &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">                      &#125; &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">                    &#125; &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">                    <span class="title function_">println</span>(<span class="string">&quot;ai-overstep-rule2 analyze end&quot;</span>) &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">                    ]]&gt;</span></span><br><span class="line"><span class="language-javascript">            </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">c-rule</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>大体说下这个基于大模型的漏洞检测规则的编写思路：首先我们需要获取拦截器配置的源码，以及拦截器定义的源码，这部分操作我们可以调用artQL的模块进行获取，然后我们再添加一些prompt，prompt包括一些必要的安全知识(实测过，如果我们没有添加这些安全知识的话，大模型是无法准确的识别到这个问题的。)：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/index/..;/admin这类的路由会被getRequestURI识别为/index/..;/admin，可能会绕过一些拦截器的逻辑判断，应使用getServletPath进行获取。</span><br></pre></td></tr></table></figure>
<p>最后我们调用大模型分析模块PromptTPL，将所有的输入参数传入到模块中即可等待分析结果。下面是我们的最终分析报告：<br>输出结果如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;越权漏洞&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;checker_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ai-overstep-rule1&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;trace&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;desc&quot;</span><span class="punctuation">:</span> <span class="string">&quot;该代码存在越权漏洞。攻击者可以通过构造类似`/index/..;/admin`的请求路径绕过`startsWith(\&quot;/admin\&quot;)`的检查，从而访问受保护的`/admin`路径。\n\n**修复方案：**\n使用`request.getServletPath()`替代`request.getRequestURI()`来获取请求路径，确保路径解析的正确性。\n\n修复后的代码如下：\n```java\n@Override\npublic boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object o) throws Exception &#123;\n    String requestServletPath \u003d request.getServletPath(); // 使用getServletPath获取路径\n    if (requestServletPath.startsWith(\&quot;/admin\&quot;) \u0026\u0026 null \u003d\u003d request.getSession().getAttribute(\&quot;loginUser\&quot;)) &#123;\n        request.getSession().setAttribute(\&quot;errorMsg\&quot;, \&quot;请登陆\&quot;);\n        response.sendRedirect(request.getContextPath() + \&quot;/admin/login\&quot;);\n        return false;\n    &#125; else &#123;\n        request.getSession().removeAttribute(\&quot;errorMsg\&quot;);\n        return true;\n    &#125;\n&#125;\n```\n真&quot;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;level&quot;</span><span class="punctuation">:</span> <span class="string">&quot;high&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>上述结果的描述信息如下：<br>该代码存在越权漏洞。攻击者可以通过构造类似<code>/index/..;/admin</code>的请求路径绕过<code>startsWith(&quot;/admin&quot;)</code>的检查，从而访问受保护的<code>/admin</code>路径。</p>
<p><strong>修复方案：</strong><br>使用<code>request.getServletPath()</code>替代<code>request.getRequestURI()</code>来获取请求路径，确保路径解析的正确性。</p>
<p>修复后的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object o)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">requestServletPath</span> <span class="operator">=</span> request.getServletPath(); <span class="comment">// 使用getServletPath获取路径</span></span><br><span class="line">    <span class="keyword">if</span> (requestServletPath.startsWith(<span class="string">&quot;/admin&quot;</span>) &amp;&amp; <span class="literal">null</span> == request.getSession().getAttribute(<span class="string">&quot;loginUser&quot;</span>)) &#123;</span><br><span class="line">        request.getSession().setAttribute(<span class="string">&quot;errorMsg&quot;</span>, <span class="string">&quot;请登陆&quot;</span>);</span><br><span class="line">        response.sendRedirect(request.getContextPath() + <span class="string">&quot;/admin/login&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        request.getSession().removeAttribute(<span class="string">&quot;errorMsg&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">真</span><br></pre></td></tr></table></figure>
<p>从结果上来看，deepseek的逻辑推理能力还是非常不错的，另外它还能够自动的给出相应的修复方案，这也是一个非常亮眼功能，当然也需要我们通过一些prompt策略去启发他。<br>当然，我们也可以通过一些模型训练，让大模型去掌握这些安全绕过手法，那么，我们在规则编写的时候可能就只需要给到他需要的代码块即可。</p>
<h3 id="4-2-2-newbee-mall-水平越权漏洞分析"><a href="#4-2-2-newbee-mall-水平越权漏洞分析" class="headerlink" title="4.2.2 newbee mall 水平越权漏洞分析"></a>4.2.2 newbee mall 水平越权漏洞分析</h3><p>我们再来分析下这个项目可能存在的一些水平越权漏洞。我们知道水平越权漏洞造成的主要原因是用户在进行一些操作的时候没有进行用户角色的权限校验。我们知道，在web项目中，绝大多数的敏感操作都是与数据库交互相关，所以越权的检测思路，我们不妨围绕是否越权访问数据库操作api来进行分析。我们通过源码分析不难发现，newbee这个项目的数据库操作主要是基于ibatis api，那么我们不妨将ibatis的一些数据操作api设置为sink点，然后向上回溯分析是否进行了权限校验。但是，我们如何知道哪里进行了权限校验呢？怎么进行的权限校验呢？这可能需要规则编写的工程师有丰富的研发经验，这样才能够对各种水平鉴权机制了然于胸，那么有没有一种方式，能够让我们在不知道项目中是怎么水平鉴权的情况下，还能够识别出潜在的水平鉴权的问题呢？那我们还是将这个问题丢给大模型吧。这里具体的做法是，我们可以将web入口到sql操作api之间的调用链涉及的代码喂给大模型，然后给出适当的prompt让大模型结合我们给到的上下文信息去判断当前这个数据流下这个sql操作是否存在水平越权风险。规则如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">c-rule</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>ai-overstep-rule1<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>越权漏洞检测<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        &lt;![<span class="variable constant_">CDATA</span>[</span></span><br><span class="line"><span class="language-javascript">            val <span class="attr">system_prompt</span>:<span class="title class_">String</span> = <span class="string">&quot;你是一个资深的代码安全分析专家，请深入分析以下代码的安全性，并给出修复方案(尽量简短)。回复的最后一个字请用于标记是否误报，若误报则标&#x27;假&#x27;，反之标&#x27;真&#x27;。&quot;</span> &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">            val sinks=db.<span class="property">call</span>.<span class="property">where</span>&#123; &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">              <span class="function"><span class="params">it</span>=&gt;</span>&#123; &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">                it.<span class="property">name</span>.<span class="title function_">contains</span>(<span class="string">&quot;deleteByPrimaryKey&quot;</span>) || it.<span class="property">name</span>.<span class="title function_">contains</span>(<span class="string">&quot;selectByPrimaryKey&quot;</span>) &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">              &#125; &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">            &#125; &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">            val <span class="attr">md_list</span>:<span class="title class_">ListBuffer</span>[<span class="title class_">MethodDecl</span>]=<span class="keyword">new</span> <span class="title class_">ListBuffer</span>[<span class="title class_">MethodDecl</span>] &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">            sinks.<span class="property">foreach</span>&#123; &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">              <span class="function"><span class="params">it</span>=&gt;</span>&#123; &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">if</span>(it.<span class="property">method</span>!=<span class="literal">null</span> &amp;&amp; !md_list.<span class="title function_">contains</span>(it.<span class="property">method</span>))&#123; &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">                  md_list.<span class="title function_">addOne</span>(it.<span class="property">method</span>) &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">                &#125; &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">              &#125; &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">            &#125; &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">//对所有method进行调用链分析 &lt;br&gt;</span></span></span><br><span class="line"><span class="language-javascript">            val cg = <span class="keyword">new</span> <span class="title class_">CallGraphAnalyze</span>() &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">            val chains=md_list.<span class="property">flatMap</span>&#123; &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">              <span class="function"><span class="params">it</span>=&gt;</span>&#123; &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">                cg.<span class="title function_">fetch_call_chains</span>(method = it) &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">              &#125; &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">            &#125; &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">if</span>(chains.<span class="property">nonEmpty</span>)&#123; &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> <span class="attr">code_snippet</span>:<span class="title class_">String</span>=chains.<span class="property">last</span>.<span class="property">methods</span>.<span class="title function_">map</span>(_.<span class="property">code</span>).<span class="title function_">mkString</span>(<span class="string">&quot;\n&quot;</span>) &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">                val pt = <span class="keyword">new</span> <span class="title class_">PromptTPL</span>() &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">                pt.<span class="property">user_prompt</span> = s<span class="string">&quot;请问以下代码存在越权漏洞吗？\n$&#123;code_snippet&#125;&quot;</span> &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">                pt.<span class="property">knowledge_prompt</span> = <span class="string">&quot;&quot;</span> &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">                pt.<span class="property">system_prompt</span> = system_prompt &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">                pt.<span class="property">token</span> = <span class="title class_">Source</span>.<span class="title function_">fromFile</span>(<span class="string">&quot;/Users/pony/Desktop/zsd/工作资料/data/api_secrete.txt&quot;</span>).<span class="property">mkString</span> &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">                val res = pt.<span class="property">query</span>.<span class="property">content</span> &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">if</span> (res.<span class="property">nonEmpty</span>) &#123; &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">                  <span class="keyword">if</span> (res.<span class="property">get</span>.<span class="title function_">endsWith</span>(<span class="string">&quot;真&quot;</span>)) &#123; &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">                    <span class="title function_">println</span>(<span class="string">&quot;发现漏洞&quot;</span>) &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">                    <span class="title function_">println</span>(res.<span class="property">get</span>) &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">                    <span class="title class_">Report</span>.<span class="property">flaws</span>.<span class="title function_">addOne</span>(<span class="keyword">new</span> <span class="title function_">FLAW</span>( &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">                      name = <span class="string">&quot;越权漏洞&quot;</span>, checker_name = <span class="string">&quot;ai-overstep-rule1&quot;</span>, &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">                      trace = <span class="title class_">Array</span>.<span class="property">empty</span>, desc = res.<span class="property">get</span>, level = <span class="string">&quot;high&quot;</span> &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">                    )) &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">                  &#125; &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">                &#125; &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">            &#125; &lt;br&gt;</span></span><br><span class="line"><span class="language-javascript">        ]]&gt;</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">c-rule</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>以下是检出报告：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	&quot;name&quot;: &quot;越权漏洞&quot;,</span><br><span class="line">	&quot;checker_name&quot;: &quot;ai-overstep-rule1&quot;,</span><br><span class="line">	&quot;trace&quot;: [],</span><br><span class="line">	&quot;desc&quot;: &quot;代码存在越权漏洞。`getOrderItems`方法直接根据传入的`id`查询订单信息，但没有验证当前用户是否有权限访问该订单。攻击者可以通过构造恶意请求，获取其他用户的订单信息。\n\n**修复方案：**\n在`getOrderItems`方法中添加用户权限验证，确保查询的订单属于当前登录用户。\n\n```java\n@Override\npublic List\u003cNewBeeMallOrderItemVO\u003e getOrderItems(Long id, Long userId) &#123;\n    NewBeeMallOrder newBeeMallOrder \u003d newBeeMallOrderMapper.selectByPrimaryKey(id);\n    if (newBeeMallOrder !\u003d null \u0026\u0026 newBeeMallOrder.getUserId().equals(userId)) &#123; // 验证订单是否属于当前用户\n        List\u003cNewBeeMallOrderItem\u003e orderItems \u003d newBeeMallOrderItemMapper.selectByOrderId(newBeeMallOrder.getOrderId());\n        if (!CollectionUtils.isEmpty(orderItems)) &#123;\n            List\u003cNewBeeMallOrderItemVO\u003e newBeeMallOrderItemVOS \u003d BeanUtil.copyList(orderItems, NewBeeMallOrderItemVO.class);\n            return newBeeMallOrderItemVOS;\n        &#125;\n    &#125;\n    return null;\n&#125;\n```\n\n在控制器中调用`getOrderItems`时，传入当前登录用户的`userId`：\n\n```java\n@GetMapping(\&quot;/order-items/&#123;id&#125;\&quot;)\n@ResponseBody\npublic Result info(@PathVariable(\&quot;id\&quot;) Long id, @RequestAttribute(\&quot;userId\&quot;) Long userId) &#123; // 获取当前登录用户的userId\n    List\u003cNewBeeMallOrderItemVO\u003e orderItems \u003d newBeeMallOrderService.getOrderItems(id, userId);\n    if (!CollectionUtils.isEmpty(orderItems)) &#123;\n        return ResultGenerator.genSuccessResult(orderItems);\n    &#125;\n    return ResultGenerator.genFailResult(ServiceResultEnum.DATA_NOT_EXIST.getResult());\n&#125;真&quot;,</span><br><span class="line">	&quot;level&quot;: &quot;high&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>desc内容友好展示如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">代码存在越权漏洞。`getOrderItems`方法直接根据传入的`id`查询订单信息，但没有验证当前用户是否有权限访问该订单。攻击者可以通过构造恶意请求，获取其他用户的订单信息。</span><br><span class="line"></span><br><span class="line">**修复方案：**</span><br><span class="line">在`getOrderItems`方法中添加用户权限验证，确保查询的订单属于当前登录用户。</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public List&lt;NewBeeMallOrderItemVO&gt; getOrderItems(Long id, Long userId) &#123;</span><br><span class="line">    NewBeeMallOrder newBeeMallOrder = newBeeMallOrderMapper.selectByPrimaryKey(id);</span><br><span class="line">    if (newBeeMallOrder != null &amp;&amp; newBeeMallOrder.getUserId().equals(userId)) &#123; // 验证订单是否属于当前用户</span><br><span class="line">        List&lt;NewBeeMallOrderItem&gt; orderItems = newBeeMallOrderItemMapper.selectByOrderId(newBeeMallOrder.getOrderId());</span><br><span class="line">        if (!CollectionUtils.isEmpty(orderItems)) &#123;</span><br><span class="line">            List&lt;NewBeeMallOrderItemVO&gt; newBeeMallOrderItemVOS = BeanUtil.copyList(orderItems, NewBeeMallOrderItemVO.class);</span><br><span class="line">            return newBeeMallOrderItemVOS;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return null;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">在控制器中调用`getOrderItems`时，传入当前登录用户的`userId`：</span><br><span class="line"></span><br><span class="line">@GetMapping(&quot;/order-items/&#123;id&#125;&quot;)</span><br><span class="line">@ResponseBody</span><br><span class="line">public Result info(@PathVariable(&quot;id&quot;) Long id, @RequestAttribute(&quot;userId&quot;) Long userId) &#123; // 获取当前登录用户的userId</span><br><span class="line">    List&lt;NewBeeMallOrderItemVO&gt; orderItems = newBeeMallOrderService.getOrderItems(id, userId);</span><br><span class="line">    if (!CollectionUtils.isEmpty(orderItems)) &#123;</span><br><span class="line">        return ResultGenerator.genSuccessResult(orderItems);</span><br><span class="line">    &#125;</span><br><span class="line">    return ResultGenerator.genFailResult(ServiceResultEnum.DATA_NOT_EXIST.getResult());</span><br><span class="line">&#125;真</span><br></pre></td></tr></table></figure>
<p>上述问题对应的漏洞源码是：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 详情</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/order-items/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">info</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">    List&lt;NewBeeMallOrderItemVO&gt; orderItems = newBeeMallOrderService.getOrderItems(id);</span><br><span class="line">    <span class="keyword">if</span> (!CollectionUtils.isEmpty(orderItems)) &#123;</span><br><span class="line">        <span class="keyword">return</span> ResultGenerator.genSuccessResult(orderItems);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ResultGenerator.genFailResult(ServiceResultEnum.DATA_NOT_EXIST.getResult());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> List&lt;NewBeeMallOrderItemVO&gt; <span class="title function_">getOrderItems</span><span class="params">(Long id)</span> &#123;</span><br><span class="line">    <span class="type">NewBeeMallOrder</span> <span class="variable">newBeeMallOrder</span> <span class="operator">=</span> newBeeMallOrderMapper.selectByPrimaryKey(id);</span><br><span class="line">    <span class="keyword">if</span> (newBeeMallOrder != <span class="literal">null</span>) &#123;</span><br><span class="line">        List&lt;NewBeeMallOrderItem&gt; orderItems = newBeeMallOrderItemMapper.selectByOrderId(newBeeMallOrder.getOrderId());</span><br><span class="line">        <span class="comment">//获取订单项数据</span></span><br><span class="line">        <span class="keyword">if</span> (!CollectionUtils.isEmpty(orderItems)) &#123;</span><br><span class="line">            List&lt;NewBeeMallOrderItemVO&gt; newBeeMallOrderItemVOS = BeanUtil.copyList(orderItems, NewBeeMallOrderItemVO.class);</span><br><span class="line">            <span class="keyword">return</span> newBeeMallOrderItemVOS;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们大概分析下源码，很明显，这里是存在水平越权漏洞的。因为其在进行sql操作newBeeMallOrderMapper.selectByPrimaryKey(id)的时候没有进行用户权限的判定。说明大模型的推断还是比较靠谱的。而这里大模型给到的修复方案是从数据库查询出来的userid和用户给的userid进行比较，这个方法也ok。当然他这个系统中其他逻辑代码中进行水平鉴权主要是从session中获取userid，这个也是一种办法。</p>
<h1 id="五、使用Artemis进行mr扫描"><a href="#五、使用Artemis进行mr扫描" class="headerlink" title="五、使用Artemis进行mr扫描"></a>五、使用Artemis进行mr扫描</h1><h2 id="5-1-什么是mr扫描以及为什么要进行mr扫描"><a href="#5-1-什么是mr扫描以及为什么要进行mr扫描" class="headerlink" title="5.1 什么是mr扫描以及为什么要进行mr扫描"></a>5.1 什么是mr扫描以及为什么要进行mr扫描</h2><p>mr扫描，即merge request扫描，指在进行分支合并的时候进行代码安全扫描。一般来说，在这个环节中进行扫描，我们期望是能够识别出项目的一些增量漏洞。另外，我们也希望在这个环节中的扫描能够更快速一些，这样不至于卡住我们的代码合并，毕竟有时候想要上线某个功能的心情是很迫切的，但是被扫描时间卡住，则是一种非常不好的体验。<br>现在，很多团队在增量漏洞识别方面都能够有比较不错的实践，例如基于一些漏洞管理平台针对不同代码版本进行的new code计算得出的增量漏洞识别方法，但是，在代码扫描层面实现增量却没有发现太多有相关的落地实践。探究其原因呢，我认为有以下几个主要原因，第一个是有些商业扫描器是支持mr扫描的，但是由于官方的技术帮助文档比较粗糙，以及中国区支持人员针对此类实践的支持不够到位，使得很多公司的sdl工程师都很难落地实践mr扫描；第二个是一些错误的言论在网上误导一些sdl工程师，使其认为mr扫描是一种缺乏准确性的扫描实践；第三个是购买的代码扫描器本身不支持mr扫描，例如诸多国产的代码安全扫描产品。<br>为了能够解决这一难题，Artemis静态代码安全扫描器在设计之初就考虑到了这点，所以从架构方面我就努力朝着能够更加容易进行mr扫描方向设计。下面，我为大家讲解下Artemis的mr扫描的原理以及具体的实际应用。<br>要讲清楚 Artemis mr扫描的原理，首先，我说明下，artemis在编译时捕获的是什么东西，以及产出物是什么。<br>artemis在编译时会以源码文件为单元，进行类型信息、ast结构信息、控制流信息、数据流指向信息捕获，然后将这些捕获的信息持久化存储，作为artemis的编译产出物。此时，我们捕获的语义信息不依赖外部的信息，这也是我们代码语义信息增量捕获得以实现的基本前提。<br>那么artemis是如何进行增量语义信息捕获的呢？首先，artemis会先对全量的代码信息进行hash记录，保存在source.txt中，然后我们在进行增量捕获的时候，会通过这个文件进行hash比对，从而计算出需要进行编译捕获的文件。我们计算出有增量修改的文件之后，我们就不必所有代码文件都进行捕获了，只需要捕获这些文件即可，而且我们的artemis扫描器的语义信息不依赖外部的文件，所以这里不存在什么语义信息损失的说法，我们只需要将原来捕获的语义信息拷贝过来，将增量的文件进行语义信息捕获，并替换掉原来对应的语义文件即可。<br>这一过程，我们可以通过以下的示意图进行表示：<br><img src="/images/mr.png" alt="捕获"></p>
<h2 id="5-2-使用artemis进行mr扫描"><a href="#5-2-使用artemis进行mr扫描" class="headerlink" title="5.2 使用artemis进行mr扫描"></a>5.2 使用artemis进行mr扫描</h2><p>我们以一个case为例演示下如何使用artemis进行增量代码扫描。<br>我们以owaps的这个benchmark文件为例：<a target="_blank" rel="noopener" href="https://github.com/OWASP-Benchmark/BenchmarkJava">https://github.com/OWASP-Benchmark/BenchmarkJava</a><br>这个benchmark大概有2730个文件，如果全量捕获的话，是非常耗时的。我们先使用artemis对其进行全量代码语义信息捕获，看看其耗时如何？<br>执行以下命令接口进行全量代码捕获</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Xss100m -Xms3096m -Xmx8044m  -jar Artemis.jar -p /Users/pony/Desktop/release/1.0.0/test/tt/BenchmarkJava  -od workspace</span><br></pre></td></tr></table></figure>
<p><img src="/images/p4.png" alt="捕获"><br>可以看到，artemis捕获全量源码文件大概耗时：1074s，约合18分钟。<br>下面我们来进行增量代码捕获<br>我们随便修改下一个文件的代码，使其hash改变。然后我们使用artemis对这个项目进行捕获。<br>命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Xss100m -Xms3096m -Xmx8044m  -jar Artemis.jar -p /Users/pony/Desktop/release/1.0.0/test/BenchmarkJava-master  -od workspace</span><br></pre></td></tr></table></figure>
<p>可以发现，使用增量捕获之后，捕获时间仅仅花了75s，比全量捕获整整省了93.1%的时间，这显然是一个非常喜人的结果，尤其是对于一些需要在流水线上进行卡点且对扫描准确性和覆盖率要求比较高的项目，这无疑是一个福音。</p>
<h1 id="六、静态代码分析技术的展望"><a href="#六、静态代码分析技术的展望" class="headerlink" title="六、静态代码分析技术的展望"></a>六、静态代码分析技术的展望</h1><p>随着大模型的发展，静态代码也将迎来新的契机。之前一些使用传统手段无法很好解决的问题，比如误报判定，更加专业性及针对性的代码修复建议，自动化代码修复，逻辑漏洞的分析等等，都将因为大模型的引入而有了新的解决思路。而有了大模型的引入，一些老牌的静态代码厂商形成的技术壁垒可能会被一系列基于大模型的创新的检测策略打破，一些致力于更深层次代码分析的实践者，抓住机遇，或许能够在这个领域形成新的竞争力。</p>
<h1 id="七、知识星球"><a href="#七、知识星球" class="headerlink" title="七、知识星球"></a>七、知识星球</h1><p>如果阁下对静态代码分析也感兴趣，想长期在这个领域进行研究学习，欢迎加入我的知识星球，我将定期在知识星球里分享我在静态代码分析方面的实践思路，当然，在知识星球中的同学也将优先获取最新版本的Artemis代码安全扫描器的体验权。<br><img src="/images/image.png" alt="星球"></p>
<h1 id="八、程序下载地址"><a href="#八、程序下载地址" class="headerlink" title="八、程序下载地址"></a>八、程序下载地址</h1><p><a target="_blank" rel="noopener" href="https://github.com/zsdlove/Artemis-release/releases/tag/v1.0.0">Artemis-release-v1.0.0</a></p>
<h1 id="使用说明"><a href="#使用说明" class="headerlink" title="使用说明"></a>使用说明</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pony@ponydeMBP 1.0.0 % java -jar Artemis.jar -h</span><br><span class="line">Usage: SAST [-hV] [-bc=&lt;build_cmd&gt;] [-d=&lt;dbpath&gt;] [-j=&lt;java_home&gt;]</span><br><span class="line">            [-mr=&lt;mr_enable&gt;] [-od=&lt;out_dbpath&gt;] [-p=&lt;path&gt;] [-r=&lt;rulePath&gt;]</span><br><span class="line">            [-t=&lt;mr_target_path&gt;]</span><br><span class="line">static code analysis.</span><br><span class="line">      -bc, --build-command=&lt;build_cmd&gt;</span><br><span class="line">                            指定编译命令.</span><br><span class="line">  -d, --database=&lt;dbpath&gt;   指定加载的数据库路径.</span><br><span class="line">  -h, --help                Show this help message and exit.</span><br><span class="line">  -j, --java-home=&lt;java_home&gt;</span><br><span class="line">                            指定java_home路径.</span><br><span class="line">      -mr, --mr-enable=&lt;mr_enable&gt;</span><br><span class="line">                            是否启用mr扫描.</span><br><span class="line">      -od, --output-database=&lt;out_dbpath&gt;</span><br><span class="line">                            指定输出的编译数据库路径.</span><br><span class="line">  -p, --path=&lt;path&gt;         指定源码路径.</span><br><span class="line">  -r, --rule=&lt;rulePath&gt;     指定规则路径.</span><br><span class="line">  -t, --mr-target-path=&lt;mr_target_path&gt;</span><br><span class="line">                            指定target数据库路径.</span><br><span class="line">  -V, --version             Print version information and exit.</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zsdlove.github.io/2025/03/03/hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="pOny">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="pOny's blog">
      <meta itemprop="description" content="安全扫描技术分享">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | pOny's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/03/03/hello-world/" class="post-title-link" itemprop="url">欢迎</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2025-03-03 19:48:27 / Modified: 20:22:45" itemprop="dateCreated datePublished" datetime="2025-03-03T19:48:27+08:00">2025-03-03</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>欢迎来到我的技术博客。我本人主要专注在静态代码分析领域，如果你在这方面有兴趣，可加微信交流：<a href="mailto:&#55;&#52;&#x37;&#50;&#x38;&#x39;&#54;&#x33;&#57;&#64;&#x71;&#113;&#46;&#x63;&#111;&#x6d;">747289639@qq.com</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>





</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">pOny</span>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
